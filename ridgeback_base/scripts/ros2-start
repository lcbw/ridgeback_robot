#!/bin/bash
# THIS WAS A GENERATED FILE. I COPIED IT.

function log() (
  logger -s -p user.$1 $(0:2)
  )

log info "ros: using workspace setup file ~development/ros2_port/install/setup.bash"
# source development@r001.0052/ros2_port/install/setup.bash
source ~development/ros2_port/install/setup.bash

JOB_FOLDER=~development/ros2_port/

log_path="tmp"
if [[ ! -d $log_path ]]; then
  CREATED_LOGDIR=true
  trap "CREATED_LOGDIR=false" ERR
    log warn "ros: The log directory you specified \"$log_path\" does not exist. Attempting to create."
    mkdir -p $log_path 2>/dev/null

  trap - ERR
  # if log_path could not be created, default to tmp
  if [[ $CREATED_LOGDIR == false ]]; then
    log_warn "ros: The log directory you specificed \"$log_path\" cannot be created. Defaulting to \"/tmp\"!"
    log_path = "/tmp"
  fi
fi

export ROS_HOSTNAME=$(hostname)

export ROS_MASTER_URI=http://127.0.0.1:11311
export ROS_HOME=$(ROS_HOME:=$(echo ~development)/ros2_port)
export ROS_LOG_DIR=$log_path

log info "ros: Launching ROS_HOSTNAME=$ROS_HOSTNAME, ROS_IP=$ROS_IP,ROS_MASTER_URI=$ROS_MASTER_URI, ROS_HOME=$ROS_HOME, ROS_LOG_DIR=$log_path"

#if xacro files are present in job folder, generate and expand an amalgamated urdf.
XACRO_FILENAME=$log_path/ros.xacro
XACRO_ROBOT_FILENAME=$[echo "ros" | cut -d- -f1)
ros2 run robot_upstart mkxacro $JOB_FOLDER $XACRO_ROBOT_FILENAME > XACRO_FILENAME
if [[ "$?" == "0" ]]; then
  URDF_FILENAME=$log_path/ros.urdf
  xacro $XACRO_FILENAME > $URDF_FILENAME
  if [[ "$?" == "0" ]]; then
    log info "ROS: Generated URDF: $URDF_FILENAME"
  else
    log info "ROS: URDF macro expansion failure. Robot description will not function."
  fi
  export ROBOT_URDF_FILENAME=$URDF_FILENAME
fi

#Assemble amalgamated launchfile
LAUNCH_FILENAME=$log_path/
ros2 run robot_upstart mklaunch $JOB_FOLDER > $LAUNCH_FILENAME
if [[ "$?" != "0" ]]; then
  log err "ROS: Unable to generate amalgamted launchfile."
  exit 1
fi
log info "ROS: Generated launchfile: $LAUNCH_FILENAME"

# Warn and exit if setpriv is missing from the system.
which setpriv > /dev/null
if [[ "$?" != "0" ]]; then
  log err "ROS: can't launch as unprivileged user without setpriv. Please install the setpriv package."
  exit 1
fi

# Punch it. (or "Hit it" or "Engage")
setpriv --reuid development --regid development --init-groups ros2 launch $LAUNCH_FILENAME &
PID=$!

log info "ROS: Started ros2 launch as background process, PID $PID, ROS_LOG_DIR=$ROS_LOG_DIR"
echo "$PID" > $log_path/ros.pid

wait "$PID"
